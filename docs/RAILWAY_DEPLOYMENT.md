# Railway Deployment Guide for Job Multi-Post MVP ðŸš‚

## Quick Start (5 Minutes to Deploy)

### 1. Install Railway CLI
```bash
# macOS/Linux
curl -fsSL https://railway.app/install.sh | sh

# Windows (PowerShell)
irm https://railway.app/install.ps1 | iex

# Or use npm
npm install -g @railway/cli
```

### 2. Login to Railway
```bash
railway login
```

### 3. Deploy Backend

```bash
cd backend

# Initialize Railway project
railway init

# Link to GitHub (recommended) or deploy directly
railway link

# Add PostgreSQL and Redis
railway add postgresql
railway add redis

# Deploy
railway up
```

### 4. Set Environment Variables

Run this command to set all required environment variables:

```bash
railway variables set \
  JWT_SECRET="$(openssl rand -hex 32)" \
  STRIPE_SECRET_KEY="sk_test_51..." \
  STRIPE_WEBHOOK_SECRET="whsec_..." \
  STRIPE_PRICE_PER_JOB="299" \
  NODE_ENV="production" \
  PORT="3001" \
  FRONTEND_URL="https://your-app.vercel.app" \
  LLM_PROVIDER="anthropic" \
  ANTHROPIC_API_KEY="sk-ant-api03-..." \
  LLM_FALLBACK_PROVIDER="groq" \
  GROQ_API_KEY="gsk_..."
```

## Environment Variables (Complete List)

### Auto-Generated by Railway
```env
DATABASE_URL         # PostgreSQL connection (auto-set)
REDIS_URL           # Redis connection (auto-set)
RAILWAY_ENVIRONMENT # Current environment
```

### Required Manual Configuration
```env
# Authentication
JWT_SECRET=your-secure-random-string-here

# Stripe (Get from https://dashboard.stripe.com)
STRIPE_SECRET_KEY=sk_test_... (or sk_live_... for production)
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_PER_JOB=299

# Application
NODE_ENV=production
PORT=3001
FRONTEND_URL=https://your-frontend.vercel.app

# LLM Configuration (Choose one or more)
LLM_PROVIDER=anthropic              # Primary: anthropic, openai, or groq
ANTHROPIC_API_KEY=sk-ant-api03-...  # If using Anthropic
OPENAI_API_KEY=sk-...               # If using OpenAI
GROQ_API_KEY=gsk_...                # If using Groq

# Optional LLM Fallback
LLM_FALLBACK_PROVIDER=groq          # Fallback provider
LLM_COST_LIMIT=1.00                 # Max cost per operation in USD
```

## Step-by-Step Deployment

### Step 1: Create Railway Project
```bash
# Option A: Deploy from GitHub (Recommended)
railway init --github

# Option B: Deploy from local
railway init
```

### Step 2: Add Services
```bash
# Add PostgreSQL
railway add postgresql

# Add Redis
railway add redis

# Services will be automatically linked via environment variables
```

### Step 3: Configure Build
Railway automatically detects the Dockerfile. The existing configuration in `railway.toml` is already optimized:

```toml
[build]
builder = "DOCKERFILE"

[deploy]
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 10
```

### Step 4: Deploy Backend
```bash
# Deploy to Railway
railway up

# Or if using GitHub
git push  # Railway auto-deploys on push
```

### Step 5: Run Database Migrations
```bash
# Run migrations after first deployment
railway run npm run migrate

# Seed initial data
railway run npm run seed
```

### Step 6: Configure Stripe Webhook
1. Get your Railway URL:
   ```bash
   railway open
   ```
2. Go to [Stripe Dashboard](https://dashboard.stripe.com/webhooks)
3. Add endpoint: `https://your-app.railway.app/api/webhooks/stripe`
4. Select event: `payment_intent.succeeded`
5. Copy webhook secret to Railway environment

### Step 7: Deploy Frontend to Vercel
```bash
cd ../frontend

# Deploy to Vercel
vercel --prod

# Set environment variable
vercel env add NEXT_PUBLIC_API_URL=https://your-backend.railway.app
vercel env add NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
```

## Railway Dashboard Configuration

### Via Web Dashboard
1. Go to [railway.app](https://railway.app)
2. Select your project
3. Click "Variables" tab
4. Add each environment variable
5. Click "Deploy" to apply changes

### Service Configuration
- **Region**: US West (default) or choose closest
- **CPU**: 1 vCPU (can scale later)
- **RAM**: 512MB (sufficient for MVP)
- **Replicas**: 1 (can add more for scaling)

## Monitoring & Debugging

### View Logs
```bash
# Live logs
railway logs

# Last 100 lines
railway logs -n 100

# Filter logs
railway logs --filter error
```

### SSH into Container
```bash
railway run bash
```

### Check Service Health
```bash
# Test health endpoint
curl https://your-app.railway.app/health

# Check database
railway run npm run db:check
```

## Cost Optimization

### Railway Pricing (as of 2024)
- **Hobby Plan**: $5/month credit included
- **Pro Plan**: $20/month (recommended for production)

### Cost Breakdown
| Resource | Usage | Estimated Cost |
|----------|-------|----------------|
| Backend App | 1 vCPU, 512MB | ~$5/month |
| PostgreSQL | 1GB storage | ~$10/month |
| Redis | 256MB | ~$5/month |
| **Total** | | **~$20/month** |

### Cost Saving Tips
1. **Use Sleep Mode**: Set min replicas to 0
2. **Optimize Images**: Use Alpine Linux (already done)
3. **Cache Aggressively**: Reduce database queries
4. **Monitor Usage**: Check Railway dashboard daily

## Production Checklist

- [ ] Environment variables set
- [ ] Database migrations run
- [ ] Redis connected
- [ ] Stripe webhook configured
- [ ] LLM API keys added
- [ ] Frontend deployed to Vercel
- [ ] Custom domain configured (optional)
- [ ] SSL certificate active (automatic)
- [ ] Health checks passing
- [ ] Monitoring enabled

## Troubleshooting

### Database Connection Issues
```bash
# Check connection
railway run npx prisma db pull

# Reset database
railway run npx prisma migrate reset --force
```

### Redis Connection Failed
```bash
# Verify Redis URL
railway variables get REDIS_URL

# Test connection
railway run node -e "const redis = require('redis'); redis.createClient(process.env.REDIS_URL).ping().then(console.log)"
```

### Build Failures
```bash
# Clear cache and rebuild
railway up --no-cache

# Check build logs
railway logs --build
```

### Stripe Webhook Not Working
1. Verify webhook secret matches
2. Check endpoint URL includes `/api/webhooks/stripe`
3. Ensure HTTPS is used (Railway provides this)
4. Test with Stripe CLI locally first

## Useful Commands

```bash
# Project Management
railway status          # Check deployment status
railway open           # Open project in browser
railway domain         # Get deployment URL

# Environment
railway variables      # List all variables
railway variables set KEY=value
railway variables get KEY

# Database
railway connect postgresql  # Connect to database
railway run npx prisma studio  # Open Prisma Studio

# Debugging
railway logs --json    # JSON formatted logs
railway run npm test   # Run tests in Railway environment
```

## Advanced Configuration

### Auto-Scaling
```javascript
// In railway.toml
[deploy]
minReplicas = 1
maxReplicas = 5
targetCPUPercent = 70
```

### Custom Domain
```bash
railway domain add yourdomain.com
```

### Scheduled Jobs
```javascript
// Use Railway cron jobs
[cron]
schedule = "0 0 * * *"  # Daily at midnight
command = "npm run cleanup"
```

## Support & Resources

- **Railway Discord**: [discord.gg/railway](https://discord.gg/railway)
- **Documentation**: [docs.railway.app](https://docs.railway.app)
- **Status Page**: [status.railway.app](https://status.railway.app)
- **Support Email**: team@railway.app

## Ready to Deploy! ðŸš€

Your application is configured and ready for Railway deployment. Follow the quick start above to deploy in 5 minutes!

### Final Command Sequence
```bash
# Complete deployment
cd backend
railway init
railway add postgresql
railway add redis
railway variables set JWT_SECRET="$(openssl rand -hex 32)"
railway up
railway run npm run migrate
railway open

# Your app is live! ðŸŽ‰
```